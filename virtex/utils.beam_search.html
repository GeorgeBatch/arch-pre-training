
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />


    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-120523111-2"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-120523111-2');
    </script>

    <link href="https://fonts.googleapis.com/css?family=Inconsolata&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono&display=swap" rel="stylesheet">


    <title>virtex.utils.beam_search &#8212; virtex 1.1 documentation</title>

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="virtex.utils.metrics" href="utils.metrics.html" />
    <link rel="prev" title="virtex.utils.checkpointing" href="utils.checkpointing.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="virtex-utils-beam-search">
<h1>virtex.utils.beam_search<a class="headerlink" href="#virtex-utils-beam-search" title="Permalink to this headline">¶</a></h1>
<hr><span class="target" id="module-virtex.utils.beam_search"></span><p>This Beam Search implementation is adapted with minor modifications from
<a class="reference external" href="https://github.com/allenai/allennlp/blob/master/allennlp/nn/beam_search.py">AllenNLP</a>.</p>
<p>Thanks to the developers of AllenNLP!</p>
<p><strong>Update (v1.2):</strong> The “backpointer” trick in Beam Search (as implemented in
AllenNLP) does not work well with autoregressive models (transformers). It is
now removed and it improves qualitative predictions and captioning metrics
(CIDEr/SPICE) for VirTex. Updated captioning results are on ArXiv v3. Refer
<a class="reference external" href="https://github.com/kdexd/virtex/blob/master/CHANGELOG.md">CHANGELOG</a> and
<a class="reference external" href="https://github.com/kdexd/virtex/releases/tag/v1.2">Release Page</a> for more
details.</p>
<p>Huge thanks to Nicolas Carion (&#64;alcinos) and Aishwarya Kamath (&#64;ashkamath) for
helping me fix this bug!</p>
<dl class="py class">
<dt class="sig sig-object py" id="virtex.utils.beam_search.AutoRegressiveBeamSearch">
<em class="property"><span class="pre">class</span> </em><span class="sig-prename descclassname"><span class="pre">virtex.utils.beam_search.</span></span><span class="sig-name descname"><span class="pre">AutoRegressiveBeamSearch</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">eos_index</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">int</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">max_steps</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">int</span></span> <span class="o"><span class="pre">=</span></span> <span class="default_value"><span class="pre">50</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">beam_size</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">int</span></span> <span class="o"><span class="pre">=</span></span> <span class="default_value"><span class="pre">5</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">per_node_beam_size</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">int</span></span> <span class="o"><span class="pre">=</span></span> <span class="default_value"><span class="pre">2</span></span></em><span class="sig-paren">)</span><a class="reference external" href="https://github.com/kdexd/virtex/blob/master/virtex/utils/beam_search.py#L25-L238"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#virtex.utils.beam_search.AutoRegressiveBeamSearch" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <code class="xref py py-class docutils literal notranslate"><span class="pre">object</span></code></p>
<p>Implements the beam search algorithm for decoding the most likely captions.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>eos_index</strong> – The index of the end token (<code class="docutils literal notranslate"><span class="pre">[EOS]</span></code>) in vocabulary.</p></li>
<li><p><strong>max_steps</strong> – The maximum number of decoding steps.</p></li>
<li><p><strong>beam_size</strong> – The width of the beam used.</p></li>
<li><p><strong>per_node_beam_size</strong> – The maximum number of candidates to consider per node,
at each step in the search. Setting this parameter to a number smaller
than <code class="docutils literal notranslate"><span class="pre">beam_size</span></code> may give better results, as it can introduce more
diversity into the search. See <a class="reference external" href="https://arxiv.org/abs/1702.01806">Beam Search Strategies for Neural
Machine Translation. Freitag and Al-Onaizan, 2017</a>.</p></li>
</ul>
</dd>
</dl>
<dl class="py method">
<dt class="sig sig-object py" id="virtex.utils.beam_search.AutoRegressiveBeamSearch.search">
<span class="sig-name descname"><span class="pre">search</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">start_predictions</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><a class="reference external" href="https://pytorch.org/docs/stable/tensors.html#torch.Tensor" title="(in PyTorch v1.9.1)"><span class="pre">torch.Tensor</span></a></span></em>, <em class="sig-param"><span class="n"><span class="pre">step</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">Callable</span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">[</span></span><span class="p"><span class="pre">...</span></span><span class="p"><span class="pre">]</span></span><span class="p"><span class="pre">,</span> </span><a class="reference external" href="https://pytorch.org/docs/stable/tensors.html#torch.Tensor" title="(in PyTorch v1.9.1)"><span class="pre">torch.Tensor</span></a><span class="p"><span class="pre">]</span></span></span></em>, <em class="sig-param"><span class="n"><span class="pre">only_return_best</span></span><span class="p"><span class="pre">:</span></span> <span class="n"><span class="pre">bool</span></span> <span class="o"><span class="pre">=</span></span> <span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span> <span class="sig-return"><span class="sig-return-icon">&#x2192;</span> <span class="sig-return-typehint"><span class="pre">Tuple</span><span class="p"><span class="pre">[</span></span><a class="reference external" href="https://pytorch.org/docs/stable/tensors.html#torch.Tensor" title="(in PyTorch v1.9.1)"><span class="pre">torch.Tensor</span></a><span class="p"><span class="pre">,</span> </span><a class="reference external" href="https://pytorch.org/docs/stable/tensors.html#torch.Tensor" title="(in PyTorch v1.9.1)"><span class="pre">torch.Tensor</span></a><span class="p"><span class="pre">]</span></span></span></span><a class="reference external" href="https://github.com/kdexd/virtex/blob/master/virtex/utils/beam_search.py#L52-L238"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#virtex.utils.beam_search.AutoRegressiveBeamSearch.search" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a starting state and a step function, apply beam search to find
the most likely target captions.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>start_predictions</strong> – Tensor containing the initial predictions, shape
<code class="docutils literal notranslate"><span class="pre">(batch_size,</span> <span class="pre">)</span></code>. Usually the initial predictions are just the
index of the start token (<code class="docutils literal notranslate"><span class="pre">[SOS]</span></code>) in the vocabulary.</p></li>
<li><p><strong>step</strong> – A function that is responsible for computing the next most likely
tokens, given the past predictions. Predictions from all previous
timesteps are required, not just the last timestep. The function is
expected to return a tensor of shape <code class="docutils literal notranslate"><span class="pre">(group_size,</span> <span class="pre">target_vocab_size)</span></code>
containing the token logits for the next step.</p></li>
<li><p><strong>only_return_best</strong> – Whether to only return the best beam (with highest
logprobs). Set this to <code class="docutils literal notranslate"><span class="pre">False</span></code> to return all the beams. If this is
<code class="docutils literal notranslate"><span class="pre">True</span></code>, then the returned tensor is of shape <code class="docutils literal notranslate"><span class="pre">(batch_size,</span>
<span class="pre">sequence_length)</span></code>, else will be <code class="docutils literal notranslate"><span class="pre">(batch_size,</span> <span class="pre">beam_size,</span>
<span class="pre">sequence_length)</span></code>.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>Tuple of <code class="docutils literal notranslate"><span class="pre">(predictions,</span> <span class="pre">logprobs)</span></code>, where <code class="docutils literal notranslate"><span class="pre">predictions</span></code>
has shape <code class="docutils literal notranslate"><span class="pre">(batch_size,</span> <span class="pre">beam_size,</span> <span class="pre">max_steps)</span></code> and <code class="docutils literal notranslate"><span class="pre">logprobs</span></code>
has shape <code class="docutils literal notranslate"><span class="pre">(batch_size,</span> <span class="pre">beam_size)</span></code>.</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">virtex</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="usage/setup_dependencies.html">How to setup this codebase?</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage/model_zoo.html">VirTex Model Zoo</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage/pretrain.html">How to train your VirTex model?</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage/downstream.html">How to evaluate on downstream tasks?</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="config.html">virtex.config</a></li>
<li class="toctree-l1"><a class="reference internal" href="factories.html">virtex.factories</a></li>
<li class="toctree-l1"><a class="reference internal" href="data.html">virtex.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="models.html">virtex.models</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">virtex.modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="optim.html">virtex.optim</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="utils.html">virtex.utils</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="utils.common.html">virtex.utils.common</a></li>
<li class="toctree-l2"><a class="reference internal" href="utils.distributed.html">virtex.utils.distributed</a></li>
<li class="toctree-l2"><a class="reference internal" href="utils.timer.html">virtex.utils.timer</a></li>
<li class="toctree-l2"><a class="reference internal" href="utils.checkpointing.html">virtex.utils.checkpointing</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">virtex.utils.beam_search</a></li>
<li class="toctree-l2"><a class="reference internal" href="utils.metrics.html">virtex.utils.metrics</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="model_zoo.html">virtex.model_zoo</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="utils.html">virtex.utils</a><ul>
      <li>Previous: <a href="utils.checkpointing.html" title="previous chapter">virtex.utils.checkpointing</a></li>
      <li>Next: <a href="utils.metrics.html" title="next chapter">virtex.utils.metrics</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Karan Desai and Justin Johnson.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/virtex/utils.beam_search.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>